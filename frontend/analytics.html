<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - SAS Admin</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2>Spread A Smile</h2>
            </div>
            <ul class="nav-menu" id="navMenu">
                <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="visits.html" class="nav-link">Visits</a></li>
                <li><a href="teams.html" class="nav-link">Teams</a></li>
                <li><a href="visit-gallery.html" class="nav-link">Gallery</a></li>
                <li><a href="profile.html" class="nav-link">Profile</a></li>
                <li><a href="contact.html" class="nav-link">Contact</a></li>
                <!-- Admin-only navigation items will be added dynamically -->
                <li><span class="nav-link" id="navUser">Welcome, User</span></li>
                <li><a href="#" class="nav-link logout-btn" id="navLogout">Logout</a></li>
            </ul>
        </div>
    </nav>

    <section class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <h1>SAS Impact Analytics</h1>
                <p>Track performance and measure impact across all activities</p>
            </div>

            <!-- Overview Stats -->
            <div class="analytics-section">
                <h2>Overview</h2>
                <div class="stats-grid" id="overviewStats">
                    <div class="stat-card large">
                        <h3>Total Children Reached</h3>
                        <div class="stat-number" id="totalChildren">0</div>
                        <div class="stat-trend">Across all visits</div>
                    </div>
                    <div class="stat-card">
                        <h3>Volunteers</h3>
                        <div class="stat-number" id="totalVolunteers">0</div>
                        <div class="stat-label">Active</div>
                    </div>
                    <div class="stat-card">
                        <h3>Schools</h3>
                        <div class="stat-number" id="totalSchools">0</div>
                        <div class="stat-label">Partner</div>
                    </div>
                    <div class="stat-card">
                        <h3>Visits</h3>
                        <div class="stat-number" id="totalVisits">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="analytics-section">
                <h2>Performance Metrics</h2>
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Monthly Visits Trend</h3>
                        <canvas id="visitsTrendChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Children Response Distribution</h3>
                        <canvas id="responseChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Volunteers by Department</h3>
                        <canvas id="departmentChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>School Feedback Ratings</h3>
                        <canvas id="feedbackChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- School Performance -->
            <div class="analytics-section">
                <h2>School Performance</h2>
                <div class="performance-grid">
                    <div class="performance-card">
                        <h3>Top Schools by Visits</h3>
                        <div id="topSchoolsList" class="performance-list">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>
                    <div class="performance-card">
                        <h3>Top Performing Teams</h3>
                        <div id="topTeamsList" class="performance-list">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Volunteer Analytics -->
            <div class="analytics-section">
                <h2>Volunteer Insights</h2>
                <div class="volunteer-grid">
                    <div class="volunteer-card">
                        <h3>Department Distribution</h3>
                        <canvas id="volunteerDeptChart"></canvas>
                    </div>
                    <div class="volunteer-card">
                        <h3>Year-wise Distribution</h3>
                        <canvas id="volunteerYearChart"></canvas>
                    </div>
                </div>
                <div class="top-volunteers">
                    <h3>Top Volunteers</h3>
                    <div id="topVolunteersList" class="volunteers-list">
                        <div class="loading">Loading top volunteers...</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // Authentication
        authManager.requireAuth();
        const user = authManager.getUser();

        let charts = {};

        // Load all analytics data
        async function loadAnalytics() {
            try {
                await loadOverview();
                await loadCharts();
                await loadPerformance();
                await loadVolunteerAnalytics();
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Load overview statistics
        async function loadOverview() {
            const data = await api.getAnalyticsOverview();
            
            if (data.success) {
                const overview = data.data.overview;
                document.getElementById('totalChildren').textContent = overview.totalChildren.toLocaleString();
                document.getElementById('totalVolunteers').textContent = overview.totalVolunteers;
                document.getElementById('totalSchools').textContent = overview.totalSchools;
                document.getElementById('totalVisits').textContent = overview.completedVisits;
            }
        }

        // Load and render charts
        async function loadCharts() {
            const [overviewData, volunteerData] = await Promise.all([
                api.getAnalyticsOverview(),
                api.getAnalyticsVolunteers()
            ]);

            if (overviewData.success) {
                renderVisitsTrendChart(overviewData.data.monthlyTrends);
                renderResponseChart(overviewData.data.responseDistribution);
            }

            if (volunteerData.success) {
                renderDepartmentChart(volunteerData.data.departmentStats);
                renderYearChart(volunteerData.data.yearStats);
            }

            // Load feedback chart
            await renderFeedbackChart();
        }

        function renderVisitsTrendChart(monthlyTrends) {
            const ctx = document.getElementById('visitsTrendChart').getContext('2d');
            const labels = monthlyTrends.map(item => `${item._id.month}/${item._id.year}`);
            const visits = monthlyTrends.map(item => item.visits);
            const children = monthlyTrends.map(item => item.children);

            if (charts.visitsTrend) charts.visitsTrend.destroy();

            charts.visitsTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Visits',
                            data: visits,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Children',
                            data: children,
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        function renderResponseChart(responseDistribution) {
            const ctx = document.getElementById('responseChart').getContext('2d');
            const labels = responseDistribution.map(item => item._id);
            const data = responseDistribution.map(item => item.count);

            const backgroundColors = {
                'excellent': '#4CAF50',
                'good': '#8BC34A',
                'average': '#FFC107',
                'poor': '#F44336'
            };

            if (charts.response) charts.response.destroy();

            charts.response = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(label => label.charAt(0).toUpperCase() + label.slice(1)),
                    datasets: [{
                        data: data,
                        backgroundColor: labels.map(label => backgroundColors[label] || '#999')
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        function renderDepartmentChart(departmentStats) {
            const ctx = document.getElementById('departmentChart').getContext('2d');
            const labels = departmentStats.map(item => item._id);
            const data = departmentStats.map(item => item.count);

            if (charts.department) charts.department.destroy();

            charts.department = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Volunteers',
                        data: data,
                        backgroundColor: '#2196F3'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderYearChart(yearStats) {
            const ctx = document.getElementById('volunteerYearChart').getContext('2d');
            const labels = yearStats.map(item => `Year ${item._id}`);
            const data = yearStats.map(item => item.count);

            if (charts.year) charts.year.destroy();

            charts.year = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        async function renderFeedbackChart() {
            const data = await api.getFeedbackStats();
            
            if (data.success) {
                const ctx = document.getElementById('feedbackChart').getContext('2d');
                const ratingDist = data.data.ratingDistribution;
                
                const labels = ratingDist.map(item => `${item._id} Stars`);
                const feedbackData = ratingDist.map(item => item.count);

                if (charts.feedback) charts.feedback.destroy();

                charts.feedback = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Number of Ratings',
                            data: feedbackData,
                            backgroundColor: '#FF9800'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        // Load performance data
        async function loadPerformance() {
            const data = await api.getAnalyticsOverview();
            
            if (data.success) {
                // Top schools
                const topSchoolsList = document.getElementById('topSchoolsList');
                topSchoolsList.innerHTML = data.data.schoolPerformance.map((school, index) => `
                    <div class="performance-item">
                        <div class="rank">${index + 1}</div>
                        <div class="details">
                            <strong>${school.school.name}</strong>
                            <div class="metrics">
                                <span>${school.visitCount} visits</span>
                                <span>${school.totalChildren} children</span>
                                ${school.averageRating ? `<span>⭐ ${school.averageRating.toFixed(1)}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');

                // Top teams
                const topTeamsList = document.getElementById('topTeamsList');
                topTeamsList.innerHTML = data.data.teamPerformance.map((team, index) => `
                    <div class="performance-item">
                        <div class="rank">${index + 1}</div>
                        <div class="details">
                            <strong>${team.team.name}</strong>
                            <div class="metrics">
                                <span>${team.visitCount} visits</span>
                                <span>${team.totalChildren} children</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Load volunteer analytics
        async function loadVolunteerAnalytics() {
            const data = await api.getAnalyticsVolunteers();
            
            if (data.success) {
                const topVolunteersList = document.getElementById('topVolunteersList');
                topVolunteersList.innerHTML = data.data.topVolunteers.map((volunteer, index) => `
                    <div class="volunteer-item">
                        <div class="volunteer-rank">${index + 1}</div>
                        <div class="volunteer-info">
                            <strong>${volunteer.volunteer.name}</strong>
                            <div>${volunteer.volunteer.department} - Year ${volunteer.volunteer.year}</div>
                        </div>
                        <div class="volunteer-stats">
                            <span>${volunteer.visitCount} visits</span>
                            <span>${volunteer.totalChildren} children</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Load analytics on page load
        loadAnalytics();
    </script>

    <!-- Shared JavaScript Modules -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/navbar.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/loading.js"></script>
    <script src="js/app.js"></script>

    <style>
        .analytics-section {
            margin-bottom: 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card.large {
            grid-column: span 1;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4CAF50;
            margin: 10px 0;
        }

        .stat-trend {
            color: #666;
            font-size: 0.9rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            margin: 0 0 15px 0;
            text-align: center;
        }

        .performance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .performance-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .performance-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .performance-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .performance-item:last-child {
            border-bottom: none;
        }

        .rank {
            background: #4CAF50;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .details {
            flex: 1;
        }

        .metrics {
            display: flex;
            gap: 15px;
            margin-top: 5px;
            font-size: 0.9rem;
            color: #666;
        }

        .volunteer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .volunteer-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .top-volunteers {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .volunteers-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .volunteer-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .volunteer-item:last-child {
            border-bottom: none;
        }

        .volunteer-rank {
            background: #2196F3;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .volunteer-info {
            flex: 1;
        }

        .volunteer-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</body>
</html>