<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Spread a Smile</title>

    <!-- Consolidated CSS -->
    <link rel="stylesheet" href="css/style.css" />
    <!-- Inline styles for dashboard gallery slider (minimal, targeted) -->
    <style>
      .gallery-slider {
        width: 100% !important;
        min-height: 400px !important;
        overflow: hidden !important;
        border-radius: 10px !important;
        background: #f5f5f5 !important;
        position: relative !important;
      }
      .gallery-slides {
        display: flex !important;
        transition: transform 0.6s ease-in-out !important;
        position: relative !important;
      }
      .gallery-slide {
        min-width: 100% !important;
        flex-shrink: 0 !important;
        position: relative !important;
        opacity: 1 !important;
        display: block !important;
      }
      .gallery-slide img {
        width: 100% !important;
        height: 450px !important;
        object-fit: contain !important;
        display: block !important;
        background: #fff !important;
      }
      .gallery-slide video {
        width: 100% !important;
        height: 450px !important;
        object-fit: contain !important;
        display: block !important;
      }
      .gallery-controls-horizontal {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
      }
      .gallery-btn-horizontal {
        background: #2e6ad6;
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      }
      .gallery-btn-horizontal:hover {
        background: #1e4fb5;
      }
      .gallery-indicators {
        text-align: center;
        margin-top: 12px;
      }
      .gallery-indicators .indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #ccc;
        margin: 0 5px;
        cursor: pointer;
      }
      .gallery-indicators .indicator.active {
        background: #2e6ad6;
      }
    </style>
  </head>

  <body>
    <nav class="navbar">
      <div class="nav-container">
        <div class="nav-logo">
          <h2>Spread A Smile</h2>
        </div>
        <ul class="nav-menu" id="navMenu">
          <li>
            <a href="dashboard.html" class="nav-link active">Dashboard</a>
          </li>
          <li><a href="visits.html" class="nav-link">Visits</a></li>
          <li><a href="teams.html" class="nav-link">Teams</a></li>
          <li><a href="visit-gallery.html" class="nav-link">Gallery</a></li>
          <li><a href="profile.html" class="nav-link">Profile</a></li>
          <li><a href="contact.html" class="nav-link">Contact</a></li>
          <!-- Admin-only navigation items will be added dynamically -->
          <li><span class="nav-link" id="navUser">Welcome, User</span></li>
          <li>
            <a href="#" class="nav-link logout-btn" id="navLogout">Logout</a>
          </li>
        </ul>
      </div>
    </nav>

    <section class="dashboard">
      <div class="container">
        <div class="dashboard-header">
          <h1>Welcome back, <span id="userName">User</span>!</h1>
          <p id="userInfo">Loading your information...</p>
        </div>

        <!-- Latest Visit Gallery - Horizontal scrolling at top -->
        <div class="dashboard-card gallery-card-horizontal">
          <div class="gallery-header">
            <h3>üì∏ Latest Visit Highlights</h3>
            <p id="galleryInfo">Loading latest visit...</p>
          </div>
          <div id="galleryContainer">
            <div class="no-gallery">
              <div class="no-gallery-icon">üñºÔ∏è</div>
              <p>No completed visits with media yet</p>
            </div>
          </div>
        </div>

        <!-- Admin Stats Section (visible only for admins) -->
        <div class="admin-stats" id="adminStats" style="display: none">
          <div class="stat-card">
            <h3>Total Volunteers</h3>
            <div class="stat-number" id="totalVolunteers">0</div>
          </div>
          <div class="stat-card">
            <h3>Active Volunteers</h3>
            <div class="stat-number" id="activeVolunteers">0</div>
          </div>
          <div class="stat-card">
            <h3>Total Teams</h3>
            <div class="stat-number" id="totalTeams">0</div>
          </div>
          <div class="stat-card">
            <h3>Unassigned Volunteers</h3>
            <div class="stat-number" id="unassignedVolunteers">0</div>
          </div>
        </div>

        <div class="dashboard-grid">
          <!-- Quick Stats -->
          <div class="dashboard-card stats-card">
            <h3>Your Activity Summary</h3>
            <div class="quick-stats" id="quickStats">
              <div class="stat-item">
                <span class="stat-number" id="totalVisitsCount">0</span>
                <span class="stat-label">Total Visits</span>
              </div>
              <div class="stat-item">
                <span class="stat-number" id="upcomingVisitsCount">0</span>
                <span class="stat-label">Upcoming</span>
              </div>
              <div class="stat-item">
                <span class="stat-number" id="completedVisitsCount">0</span>
                <span class="stat-label">Completed</span>
              </div>
            </div>
          </div>

          <!-- Upcoming Visits -->
          <div class="dashboard-card upcoming-visits-card">
            <h3>Upcoming Visits</h3>
            <div class="visit-list-horizontal" id="upcomingVisits">
              <p>Loading visits...</p>
            </div>
          </div>
        </div>

        <!-- Teams Section - Visible only for admins -->
        <div class="teams-section" id="teamsSection" style="display: none">
          <h2>All Teams</h2>
          <div id="teamsList" class="teams-list"></div>
        </div>
      </div>
    </section>

    <footer class="footer">
      <div class="container">
        <p>&copy; 2025 Spread a Smile (SAS). All rights reserved.</p>
      </div>
    </footer>

    <!-- Shared JavaScript Modules -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/navbar.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/loading.js"></script>
    <script src="js/app.js"></script>

    <!-- Page-specific JavaScript -->
    <script>
      // Check authentication
      authManager.requireAuth();

      const user = authManager.getUser();

      // Setup user interface
      function setupUserInterface() {
        // Update the username display
        document.getElementById("userName").textContent = user.name || "User";
        document.getElementById(
          "userInfo"
        ).textContent = `Welcome back! Manage volunteers, teams, and school visits`;

        // Setup navbar with admin menu items
        navbarManager.setupNavbar();
      }

      async function loadDashboardData() {
        try {
          // Show loading state
          loading.showSkeleton("upcomingVisits", 3, "card");

          // Load all stats for all users
          await loadAdminStats();

          // Load upcoming visits
          await loadUpcomingVisits();

          // Load latest visit gallery
          await loadLatestVisitGallery();
        } catch (error) {
          handleAPIError(error);
        }
      }

      // Admin-specific stats
      async function loadAdminStats() {
        try {
          const data = await api.get("/admin/stats");

          if (data.success) {
            document.getElementById("totalVolunteers").textContent =
              data.data.totalVolunteers;
            document.getElementById("activeVolunteers").textContent =
              data.data.activeVolunteers;
            document.getElementById("totalTeams").textContent =
              data.data.totalTeams;
            document.getElementById("unassignedVolunteers").textContent =
              data.data.volunteersWithoutTeam;

            // Show admin stats section
            const adminStatsEl = document.getElementById("adminStats");
            if (adminStatsEl) adminStatsEl.style.display = "grid";
          }
        } catch (error) {
          console.error("Error loading admin stats:", error);
        }
      }

      // Upcoming visits - display horizontally
      async function loadUpcomingVisits() {
        try {
          const data = await api.getVisits();

          if (data.success) {
            const upcoming = data.data.filter(
              (visit) => visit.status === "scheduled"
            );
            const visitsContainer = document.getElementById("upcomingVisits");

            // Update activity summary counts
            const totalVisits = data.data.length;
            const upcomingCount = upcoming.length;
            const completedCount = data.data.filter(
              (v) => v.status === "completed"
            ).length;

            document.getElementById("totalVisitsCount").textContent =
              totalVisits;
            document.getElementById("upcomingVisitsCount").textContent =
              upcomingCount;
            document.getElementById("completedVisitsCount").textContent =
              completedCount;

            if (upcoming.length > 0) {
              visitsContainer.innerHTML = upcoming
                .map(
                  (visit) => `
              <div class="visit-card-horizontal">
                <div class="visit-card-content">
                  <h4>üìÖ ${utils.formatDate(visit.date)}</h4>
                  <p>üè´ ${visit.school?.name || "School"}</p>
                  <p>üë• Class: ${visit.assignedClass}</p>
                  <span class="status-badge upcoming">Scheduled</span>
                </div>
              </div>
            `
                )
                .join("");
            } else {
              visitsContainer.innerHTML =
                "<p>No upcoming visits scheduled.</p>";
            }
          }
        } catch (error) {
          console.error("Error loading visits:", error);
          renderError("upcomingVisits", "Failed to load upcoming visits");
        }
      }

      // Load latest completed visit with gallery
      let galleryInterval = null;
      let currentSlide = 0;
      let galleryMedia = [];
      const GALLERY_AUTO_MS = 2000; // Auto-scroll interval in ms (2s)

      async function loadLatestVisitGallery() {
        try {
          // Fetch all gallery media (no filters - get everything)
          const galleryResponse = await api.getAllGalleryMedia();

          if (
            galleryResponse.success &&
            galleryResponse.data &&
            galleryResponse.data.length > 0
          ) {
            const baseURL = CONFIG.API_BASE_URL.replace("/api", "");

            // Group media by visit to get the latest visit
            const mediaByVisit = {};

            for (const item of galleryResponse.data) {
              const visitId = item.visitId;
              if (!mediaByVisit[visitId]) {
                mediaByVisit[visitId] = {
                  visitId: visitId,
                  visitName: item.visitName,
                  visitDate: item.visitDate,
                  school: item.school,
                  team: item.team,
                  media: [],
                };
              }
              mediaByVisit[visitId].media.push(item);
            }

            // Get the most recent visit (sorted by date)
            const visits = Object.values(mediaByVisit).sort(
              (a, b) => new Date(b.visitDate) - new Date(a.visitDate)
            );

            if (visits.length === 0 || visits[0].media.length === 0) {
              showNoGallery();
              return;
            }

            const latestVisit = visits[0];

            // Prepare media array with proper URL construction
            galleryMedia = latestVisit.media.map((item) => {
              let mediaUrl = item.url;

              // Ensure proper URL format
              if (mediaUrl && !mediaUrl.startsWith("http")) {
                // Add leading slash if missing
                if (!mediaUrl.startsWith("/")) {
                  mediaUrl = "/" + mediaUrl;
                }
                // Prepend base URL
                mediaUrl = baseURL + mediaUrl;
              }

              return {
                type: item.type,
                url: mediaUrl,
                visitInfo: {
                  name: item.visitName,
                  date: item.visitDate,
                  school: item.school,
                },
              };
            });

            if (galleryMedia.length > 0) {
              displayGallery(latestVisit);
              startAutoScroll();
            } else {
              showNoGallery();
            }
          } else {
            showNoGallery();
          }
        } catch (error) {
          console.error("Error loading latest visit gallery:", error);
          showNoGallery();
        }
      }

      function displayGallery(visit) {
        const galleryInfo = document.getElementById("galleryInfo");
        const galleryContainer = document.getElementById("galleryContainer");

        // Update header
        galleryInfo.innerHTML = `
          <strong>${visit.school?.name || "School Visit"}</strong> - 
          ${utils.formatDate(visit.visitDate)} - 
          ${galleryMedia.length} ${galleryMedia.length === 1 ? "item" : "items"}
        `;

        // Build slides
        const slidesHTML = galleryMedia
          .map((media, index) => {
            if (media.type === "photo") {
              return `<div class="gallery-slide"><img src="${
                media.url
              }" alt="Visit photo ${index + 1}"></div>`;
            }
            return `<div class="gallery-slide"><video src="${media.url}" controls muted loop></video></div>`;
          })
          .join("");

        // Render slider
        galleryContainer.innerHTML = `
          <div class="gallery-slider">
            <div class="gallery-slides" id="gallerySlides">
              ${slidesHTML}
            </div>
          </div>
          <div class="gallery-indicators" id="galleryIndicators">
            ${galleryMedia
              .map(
                (_, i) =>
                  `<span class="indicator ${
                    i === 0 ? "active" : ""
                  }" data-index="${i}"></span>`
              )
              .join("")}
          </div>
          <div class="gallery-controls-horizontal">
            <button class="gallery-btn-horizontal" id="prevBtn">‚¨ÖÔ∏è Prev</button>
            <button class="gallery-btn-horizontal" id="autoScrollBtn">‚è∏Ô∏è Pause</button>
            <button class="gallery-btn-horizontal" id="nextBtn">Next ‚û°Ô∏è</button>
          </div>
        `;

        // Setup handlers
        currentSlide = 0;
        document.getElementById("prevBtn").onclick = () => moveToPrev();
        document.getElementById("nextBtn").onclick = () => moveToNext();
        document.getElementById("autoScrollBtn").onclick = () =>
          toggleAutoScroll();

        // Indicators click
        document
          .querySelectorAll("#galleryIndicators .indicator")
          .forEach((ind) => {
            ind.onclick = () => moveToSlide(Number(ind.dataset.index));
          });
      }

      function showNoGallery() {
        const galleryInfo = document.getElementById("galleryInfo");
        const galleryContainer = document.getElementById("galleryContainer");

        galleryInfo.textContent = "No recent visits with media";
        galleryContainer.innerHTML = `
        <div class="no-gallery">
          <div class="no-gallery-icon">üñºÔ∏è</div>
          <p>No completed visits with photos or videos yet.</p>
          <p style="margin-top: 10px; font-size: 0.9rem;">Submit a visit report with media to see it here!</p>
        </div>
      `;
      }

      function startAutoScroll() {
        if (galleryInterval) clearInterval(galleryInterval);
        galleryInterval = setInterval(() => {
          moveToNext();
        }, GALLERY_AUTO_MS); // Auto-scroll (configurable)
      }

      function stopAutoScroll() {
        if (galleryInterval) {
          clearInterval(galleryInterval);
          galleryInterval = null;
        }
      }

      function toggleAutoScroll() {
        const btn = document.getElementById("autoScrollBtn");
        if (galleryInterval) {
          stopAutoScroll();
          btn.textContent = "‚ñ∂Ô∏è Play";
        } else {
          startAutoScroll();
          btn.textContent = "‚è∏Ô∏è Pause";
        }
      }

      function moveToSlide(index) {
        if (galleryMedia.length === 0) return;
        const slidesEl = document.getElementById("gallerySlides");
        const max = galleryMedia.length;
        currentSlide = ((index % max) + max) % max; // wrap
        const percent = -currentSlide * 100;
        slidesEl.style.transform = `translateX(${percent}%)`;
        updateIndicators();
        updateVideoPlayback();
      }

      function moveToNext() {
        moveToSlide(currentSlide + 1);
      }

      function moveToPrev() {
        moveToSlide(currentSlide - 1);
      }

      function updateIndicators() {
        const inds = document.querySelectorAll("#galleryIndicators .indicator");
        inds.forEach((el, idx) => {
          if (idx === currentSlide) el.classList.add("active");
          else el.classList.remove("active");
        });
      }

      // Old vertical carousel functions (keep for backward compatibility)
      function nextSlide() {
        if (galleryMedia.length === 0) return;

        const slides = document.querySelectorAll(".gallery-slide");
        const indicators = document.querySelectorAll(".indicator");

        slides[currentSlide].classList.remove("active");
        indicators[currentSlide].classList.remove("active");

        currentSlide = (currentSlide + 1) % galleryMedia.length;

        slides[currentSlide].classList.add("active");
        indicators[currentSlide].classList.add("active");

        // Auto-pause video when leaving, auto-play when entering
        updateVideoPlayback();
      }

      function prevSlide() {
        if (galleryMedia.length === 0) return;

        const slides = document.querySelectorAll(".gallery-slide");
        const indicators = document.querySelectorAll(".indicator");

        slides[currentSlide].classList.remove("active");
        indicators[currentSlide].classList.remove("active");

        currentSlide =
          (currentSlide - 1 + galleryMedia.length) % galleryMedia.length;

        slides[currentSlide].classList.add("active");
        indicators[currentSlide].classList.add("active");

        updateVideoPlayback();
      }

      function goToSlide(index) {
        if (galleryMedia.length === 0) return;

        const slides = document.querySelectorAll(".gallery-slide");
        const indicators = document.querySelectorAll(".indicator");

        slides[currentSlide].classList.remove("active");
        indicators[currentSlide].classList.remove("active");

        currentSlide = index;

        slides[currentSlide].classList.add("active");
        indicators[currentSlide].classList.add("active");

        updateVideoPlayback();
      }

      function updateVideoPlayback() {
        const slides = document.querySelectorAll(".gallery-slide");
        slides.forEach((slide, index) => {
          const video = slide.querySelector("video");
          if (video) {
            if (index === currentSlide) {
              video
                .play()
                .catch((err) => console.log("Video play error:", err));
            } else {
              video.pause();
            }
          }
        });
      }

      // Stop auto-scroll when user leaves the page
      window.addEventListener("beforeunload", () => {
        stopAutoScroll();
      });

      function openReportModal(visitId) {
        window.location.href = `visit-report.html?visitId=${visitId}`;
      }

      // Admin-specific functions
      async function createTeams() {
        notify.confirm(
          "Create teams automatically? This will assign all unassigned volunteers to teams.",
          async () => {
            try {
              loading.showFullPage("Creating teams...");

              const data = await api.createBulkTeams({ teamSize: 4 });

              loading.hideFullPage();

              if (data.success) {
                notify.success(data.message);
                loadAdminStats();
              }
            } catch (error) {
              loading.hideFullPage();
              handleAPIError(error);
            }
          }
        );
      }

      // View teams function for admins
      async function viewTeams() {
        try {
          loading.show("teamsList", "Loading teams...");

          const data = await api.getTeams();

          loading.hide("teamsList");

          if (data.success) {
            displayTeams(data.data);
          }
        } catch (error) {
          loading.hide("teamsList");
          handleAPIError(error);
        }
      }

      function displayTeams(teams) {
        const teamsList = document.getElementById("teamsList");
        const teamsSection = document.getElementById("teamsSection");

        teamsSection.style.display = "block";

        if (teams.length === 0) {
          teamsList.innerHTML = "<p>No teams created yet.</p>";
          return;
        }

        teamsList.innerHTML = teams
          .map(
            (team) => `
        <div class="team-card">
          <h3>${team.name}</h3>
          <p><strong>Team Leader:</strong> ${
            team.teamLeader?.name || "Not assigned"
          }</p>
          <p><strong>Members:</strong> ${team.members.length}</p>
          <p><strong>Assigned School:</strong> ${
            team.assignedSchool?.name || "Not assigned"
          }</p>
          <div class="team-members">
            ${team.members
              .map(
                (member) =>
                  `<span class="member-tag">${member.name} (${member.department} Y${member.year})</span>`
              )
              .join("")}
          </div>
        </div>
      `
          )
          .join("");

        // Scroll to teams section
        teamsSection.scrollIntoView({ behavior: "smooth" });
      }

      // Initialize the dashboard
      setupUserInterface();
      loadDashboardData();
    </script>
  </body>
</html>
