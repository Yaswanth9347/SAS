<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password - Spread a Smile</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <!-- Consolidated CSS -->
  <link rel="stylesheet" href="css/style.css">
  
  <style>
    body {
      background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .reset-password-container {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      max-width: 500px;
      width: 100%;
      margin: 20px;
    }

    .logo-section {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo-section i {
      font-size: 60px;
      color: #2e7d32;
      margin-bottom: 10px;
    }

    .logo-section h1 {
      color: #2e7d32;
      margin: 0 0 10px 0;
      font-size: 28px;
    }

    .logo-section p {
      color: #666;
      margin: 0;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }

    .form-group label .required {
      color: #f44336;
    }

    .input-with-icon {
      position: relative;
    }

    .input-with-icon i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
    }

    .input-with-icon input {
      padding-left: 45px;
      width: 100%;
      padding: 12px 15px 12px 45px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .input-with-icon input:focus {
      outline: none;
      border-color: #2e7d32;
    }

    .input-with-icon .toggle-password {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #999;
      transition: color 0.3s ease;
    }

    .input-with-icon .toggle-password:hover {
      color: #2e7d32;
    }

    /* Password strength indicator */
    .password-strength {
      margin-top: 8px;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      overflow: hidden;
    }

    .password-strength-bar {
      height: 100%;
      width: 0;
      transition: all 0.3s ease;
    }

    .password-strength-bar.weak {
      width: 33%;
      background: #f44336;
    }

    .password-strength-bar.medium {
      width: 66%;
      background: #ff9800;
    }

    .password-strength-bar.strong {
      width: 100%;
      background: #4caf50;
    }

    .password-strength-text {
      margin-top: 5px;
      font-size: 12px;
      color: #666;
    }

    /* Password requirements */
    .password-requirements {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 6px;
      margin-top: 10px;
      margin-bottom: 20px;
    }

    .password-requirements h4 {
      margin: 0 0 10px 0;
      font-size: 13px;
      color: #333;
    }

    .requirement {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }

    .requirement i {
      width: 14px;
    }

    .requirement.met {
      color: #4caf50;
    }

    .requirement.met i {
      color: #4caf50;
    }

    .btn-submit {
      width: 100%;
      padding: 14px;
      background: #2e7d32;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-submit:hover:not(:disabled) {
      background: #1b5e20;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
    }

    .btn-submit:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .back-to-login {
      text-align: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }

    .back-to-login a {
      color: #2e7d32;
      text-decoration: none;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
    }

    .back-to-login a:hover {
      color: #1b5e20;
      gap: 8px;
    }

    .success-message {
      background: #d4edda;
      border-left: 4px solid #28a745;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
    }

    .success-message i {
      color: #28a745;
      margin-right: 8px;
    }

    .success-message p {
      margin: 0;
      font-size: 14px;
      color: #155724;
      line-height: 1.6;
    }

    .success-message.show {
      display: block;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .error-message {
      background: #f8d7da;
      border-left: 4px solid #f44336;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
    }

    .error-message i {
      color: #f44336;
      margin-right: 8px;
    }

    .error-message p {
      margin: 0;
      font-size: 14px;
      color: #721c24;
    }

    .error-message.show {
      display: block;
      animation: slideDown 0.3s ease;
    }

    .expired-token {
      text-align: center;
      padding: 40px 20px;
    }

    .expired-token i {
      font-size: 60px;
      color: #f44336;
      margin-bottom: 20px;
    }

    .expired-token h2 {
      color: #333;
      margin-bottom: 10px;
    }

    .expired-token p {
      color: #666;
      margin-bottom: 20px;
    }

    .btn-secondary {
      display: inline-block;
      padding: 12px 24px;
      background: #2e7d32;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      background: #1b5e20;
      transform: translateY(-2px);
    }

    @media (max-width: 500px) {
      .reset-password-container {
        padding: 30px 20px;
      }

      .logo-section h1 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="reset-password-container" id="mainContainer">
    <div class="logo-section">
      <i class="fas fa-key"></i>
      <h1>Reset Password</h1>
      <p>Enter your new password below</p>
    </div>

    <div class="success-message" id="successMessage">
      <i class="fas fa-check-circle"></i>
      <p>Your password has been reset successfully! Redirecting to login...</p>
    </div>

    <div class="error-message" id="errorMessage">
      <i class="fas fa-exclamation-circle"></i>
      <p id="errorText">An error occurred. Please try again.</p>
    </div>

    <form id="resetPasswordForm">
      <div class="form-group">
        <label for="password">
          New Password <span class="required">*</span>
        </label>
        <div class="input-with-icon">
          <i class="fas fa-lock"></i>
          <input 
            type="password" 
            id="password" 
            name="password" 
            placeholder="Enter your new password" 
            required 
            minlength="6"
            autocomplete="new-password"
          />
          <i class="fas fa-eye toggle-password" id="togglePassword"></i>
        </div>
        <div class="password-strength">
          <div class="password-strength-bar" id="strengthBar"></div>
        </div>
        <div class="password-strength-text" id="strengthText"></div>
      </div>

      <div class="password-requirements">
        <h4>Password must contain:</h4>
        <div class="requirement" id="req-length">
          <i class="fas fa-circle"></i>
          <span>At least 6 characters</span>
        </div>
        <div class="requirement" id="req-letter">
          <i class="fas fa-circle"></i>
          <span>At least one letter</span>
        </div>
        <div class="requirement" id="req-number">
          <i class="fas fa-circle"></i>
          <span>At least one number</span>
        </div>
      </div>

      <div class="form-group">
        <label for="confirmPassword">
          Confirm New Password <span class="required">*</span>
        </label>
        <div class="input-with-icon">
          <i class="fas fa-lock"></i>
          <input 
            type="password" 
            id="confirmPassword" 
            name="confirmPassword" 
            placeholder="Confirm your new password" 
            required 
            autocomplete="new-password"
          />
          <i class="fas fa-eye toggle-password" id="toggleConfirmPassword"></i>
        </div>
      </div>

      <button type="submit" class="btn-submit" id="submitBtn" disabled>
        <i class="fas fa-check"></i>
        <span>Reset Password</span>
      </button>
    </form>

    <div class="back-to-login">
      <a href="login.html">
        <i class="fas fa-arrow-left"></i>
        <span>Back to Login</span>
      </a>
    </div>
  </div>

  <!-- Shared JavaScript Modules -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/api.js"></script>
  <script src="js/notifications.js"></script>
  <script src="js/loading.js"></script>

  <script>
    // Check if already logged in
    const token = localStorage.getItem('token');
    if (token) {
      window.location.href = 'dashboard.html';
    }

    // Get reset token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const resetToken = urlParams.get('token');

    if (!resetToken) {
      showExpiredToken('Invalid or missing reset token');
    }

    const form = document.getElementById('resetPasswordForm');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const submitBtn = document.getElementById('submitBtn');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');

    // Toggle password visibility
    document.getElementById('togglePassword').addEventListener('click', function() {
      const type = passwordInput.type === 'password' ? 'text' : 'password';
      passwordInput.type = type;
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });

    document.getElementById('toggleConfirmPassword').addEventListener('click', function() {
      const type = confirmPasswordInput.type === 'password' ? 'text' : 'password';
      confirmPasswordInput.type = type;
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });

    // Hide messages
    function hideMessages() {
      successMessage.classList.remove('show');
      errorMessage.classList.remove('show');
    }

    // Show error message
    function showError(message) {
      hideMessages();
      errorText.textContent = message;
      errorMessage.classList.add('show');
    }

    // Show expired token screen
    function showExpiredToken(message) {
      document.getElementById('mainContainer').innerHTML = `
        <div class="expired-token">
          <i class="fas fa-exclamation-triangle"></i>
          <h2>Link Expired or Invalid</h2>
          <p>${message || 'This password reset link has expired or is invalid.'}</p>
          <a href="forgot-password.html" class="btn-secondary">
            <i class="fas fa-redo"></i> Request New Link
          </a>
        </div>
        <div class="back-to-login">
          <a href="login.html">
            <i class="fas fa-arrow-left"></i>
            <span>Back to Login</span>
          </a>
        </div>
      `;
    }

    // Check password strength
    function checkPasswordStrength(password) {
      let strength = 0;
      
      if (password.length >= 6) strength++;
      if (password.length >= 10) strength++;
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
      if (/\d/.test(password)) strength++;
      if (/[^a-zA-Z\d]/.test(password)) strength++;

      return strength;
    }

    // Update password strength indicator
    function updatePasswordStrength() {
      const password = passwordInput.value;
      const strength = checkPasswordStrength(password);

      strengthBar.className = 'password-strength-bar';
      
      if (password.length === 0) {
        strengthBar.style.width = '0';
        strengthText.textContent = '';
      } else if (strength <= 2) {
        strengthBar.classList.add('weak');
        strengthText.textContent = 'Weak password';
        strengthText.style.color = '#f44336';
      } else if (strength <= 3) {
        strengthBar.classList.add('medium');
        strengthText.textContent = 'Medium password';
        strengthText.style.color = '#ff9800';
      } else {
        strengthBar.classList.add('strong');
        strengthText.textContent = 'Strong password';
        strengthText.style.color = '#4caf50';
      }
    }

    // Check password requirements
    function checkRequirements() {
      const password = passwordInput.value;
      const confirmPassword = confirmPasswordInput.value;

      // Length requirement
      const reqLength = document.getElementById('req-length');
      if (password.length >= 6) {
        reqLength.classList.add('met');
        reqLength.querySelector('i').className = 'fas fa-check-circle';
      } else {
        reqLength.classList.remove('met');
        reqLength.querySelector('i').className = 'fas fa-circle';
      }

      // Letter requirement
      const reqLetter = document.getElementById('req-letter');
      if (/[a-zA-Z]/.test(password)) {
        reqLetter.classList.add('met');
        reqLetter.querySelector('i').className = 'fas fa-check-circle';
      } else {
        reqLetter.classList.remove('met');
        reqLetter.querySelector('i').className = 'fas fa-circle';
      }

      // Number requirement
      const reqNumber = document.getElementById('req-number');
      if (/\d/.test(password)) {
        reqNumber.classList.add('met');
        reqNumber.querySelector('i').className = 'fas fa-check-circle';
      } else {
        reqNumber.classList.remove('met');
        reqNumber.querySelector('i').className = 'fas fa-circle';
      }

      // Enable/disable submit button
      const allMet = password.length >= 6 && /[a-zA-Z]/.test(password) && /\d/.test(password);
      const passwordsMatch = password === confirmPassword && confirmPassword.length > 0;
      
      submitBtn.disabled = !(allMet && passwordsMatch);
    }

    // Password input event
    passwordInput.addEventListener('input', () => {
      updatePasswordStrength();
      checkRequirements();
      hideMessages();
    });

    // Confirm password input event
    confirmPasswordInput.addEventListener('input', () => {
      checkRequirements();
      hideMessages();
    });

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const password = passwordInput.value;
      const confirmPassword = confirmPasswordInput.value;

      if (password !== confirmPassword) {
        showError('Passwords do not match');
        return;
      }

      if (password.length < 6) {
        showError('Password must be at least 6 characters');
        return;
      }

      try {
        // Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';
        hideMessages();

        const response = await api.resetPassword(resetToken, password);

        if (response.success) {
          successMessage.classList.add('show');
          form.style.display = 'none';
          
          // Redirect to login after 3 seconds
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 3000);
        } else {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="fas fa-check"></i> Reset Password';
          
          if (response.message && response.message.includes('expired')) {
            showExpiredToken(response.message);
          } else {
            showError(response.message || 'Failed to reset password. Please try again.');
          }
        }
      } catch (error) {
        console.error('Reset password error:', error);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check"></i> Reset Password';
        
        if (error.response && error.response.data) {
          if (error.response.data.message && error.response.data.message.includes('expired')) {
            showExpiredToken(error.response.data.message);
          } else {
            showError(error.response.data.message || 'An error occurred. Please try again.');
          }
        } else {
          showError('An error occurred. Please try again later.');
        }
      }
    });
  </script>
</body>
</html>
